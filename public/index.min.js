angular.module("wbt",["ui.router","ui.bootstrap","ngMessages","ngSanitize","ngAria","restangular"]),angular.module("wbt").run(["Restangular","$window","identity",function(t,e,n){t.addFullRequestInterceptor(function(t,n,r,i,o){if(!o.Authorization){var s=e.localStorage.getItem("authToken");if(s)return o.Authorization="Bearer "+s,{headers:o}}}),t.setErrorInterceptor(function(t){if(401===t.status){var r=e.localStorage.getItem("authToken");if(r)return;var i=n.login();return i.result.then(function(){return!0},function(){return!1})}return!0})}]),angular.module("wbt").controller("wbtCtrl",["$state","$stateParams","identity",function(t,e,n){this.$state=t,this.$stateParams=e,this.identity=n,n.init().then(n.get)["catch"](n.inauthenticate)}]),angular.module("wbt").config(["$stateProvider","$urlRouterProvider","$locationProvider","$compileProvider","RestangularProvider",function(t,e,n,r,i){n.html5Mode(!0),r.debugInfoEnabled(!1),i.setBaseUrl("/api"),t.state("home",{url:"/home",templateUrl:"home/home.html"}).state("content",{url:"/content",templateUrl:"content/content.html",resolve:{units:["content",function(t){return t.units()}]},controller:"contentCtrl",controllerAs:"content"}).state("content.unit",{url:"/:unit",templateUrl:"content/unit/unit.html",resolve:{unit:["content","$stateParams",function(t,e){return t.unit(e.unit)}]},controller:"unitCtrl",controllerAs:"unit","abstract":!0}).state("content.unit.description",{url:"/description",templateUrl:"content/unit/description/description.html",onEnter:["content","unit",function(t,e){return t.view(e._id)}]}).state("content.unit.test",{url:"/test",templateUrl:"content/unit/test/test.html",resolve:{items:["content","$stateParams",function(t,e){return t.tests(e.unit)}],guesses:["content","unit","items",function(t,e,n){return t.guesses(e._id,n)}]},controller:"testCtrl",controllerAs:"test"}).state("content.unit.topic",{url:"/:topic",templateUrl:"content/unit/topic/topic.html",controller:["topic",function(t){this.topic=t}],controllerAs:"topic",resolve:{topic:["content","$stateParams",function(t,e){return t.topic(e.unit,e.topic)}]},onEnter:["content","unit","topic",function(t,e,n){return t.view(e._id,n._id)}]}).state("content.unit.topic.example",{url:"/example/:example",template:'<h3 ng-bind="example.example"></h3><div math-jax md="example.example.body"></div>',controller:["example",function(t){this.example=t}],controllerAs:"example",resolve:{example:["topic","$stateParams",function(t,e){return _.find(t.examples,{title:e.example})}]}}).state("content.unit.topic.extra",{url:"/extra/:extra",template:'<h3 ng-bind="extra.extra"></h3><div math-jax md="extra.extra.body"></div>',controller:["extra",function(t){this.extra=t}],controllerAs:"extra",resolve:{extra:["topic","$stateParams",function(t,e){return _.find(t.extras,{title:e.extra})}]}}).state("software",{url:"/software",templateUrl:"software/software.html",data:{menuText:"Statistiksoftware"}}).state("download",{url:"/download",templateUrl:"download/download.html",resolve:{units:["content",function(t){return t.units()}],token:["identity",function(t){return t.authenticatedAsync()["catch"](t.login)}]},controller:"downloadCtrl",controllerAs:"download"}).state("contact",{url:"/contact",templateUrl:"contact/contact.html",data:{access:"public"}}).state("register",{url:"/register",templateUrl:"register/register.html",controller:"registerCtrl as register",data:{access:"public"}}).state("user",{url:"/user/:id",templateUrl:"user/user.html",controller:"userCtrl as user",data:{access:"user"}}),e.otherwise("/home")}]).run(["$rootScope",function(t){t.$on("$stateChangeError",function(t,e,n,r,i,o){console.error(o)})}]),angular.module("wbt").factory("content",["Restangular","$modal",function(t,e){var n=t.all("units"),r=function(){return n.withHttpConfig({cache:!0}).getList()},i=function(t){return n.withHttpConfig({cache:!0}).get(t)},o=function(t,e){return n.one(t).one("topics",e).withHttpConfig({cache:!0}).get()},s=function(t){return e.open({templateUrl:"content/unit/akzeptanz/akzeptanz.html",controller:"akzeptanzCtrl",controllerAs:"akzeptanz",resolve:{unit:function(){return t},summary:function(){return t.one("akzeptanz","summary").get()}}})},u=function(e,n,r){var i={unit:e,name:n,value:r};return t.all("ratings").post(i)},a=function(e,n){var r={unit:e,value:n};return t.all("comments").post(r)},l=function(t){return n.one(t).withHttpConfig({cache:!0}).getList("tests")},c=function(t,e){return n.one(t).one("guesses","summary").get().then(function(t){return _.forEach(t.plain(),function(n,r){var i=_.find(e,{_id:r});if(i)switch(i.type){case"single":var o=_.find(i.choices,{_id:n.single});t[r]=o;break;case"multiple":var s=i.choices;_.forEach(s,function(t,e){s[e].selected=_.contains(n.multiple,t._id)?!0:!1}),t[r]=s}}),t.plain()})},m=function(e,n,r){var i={unit:e,item:n._id,response:{}};switch(n.type){case"single":i.response.single=r._id;break;case"multiple":r=_.filter(r,"selected"),i.response.multiple=_.map(r,"_id");break;case"input":i.response.input=r}return t.all("guesses").post(i)},h=function(t){return _.reduce(t,function(t,e){switch(e.type){case"single":return t+1;case"multiple":return t+e.choices.length;default:return t+1}},0)},f=function(t){var e=_.reduce(t,function(t,e){if(_.isArray(e)){var n=_.reduce(e,function(t,e){return e.correct===e.selected?t+1:t},0);return t+n}return _.isObject(e)?e.correct?t+1:t:void 0},0);return e},d=function(t){switch(t.type){case"single":return{};case"multiple":var e=t.choices;return _.forEach(e,function(t){t.selected=!1}),e;case"input":return"";default:return{}}},p=function(e,n){var r={unit:e};return n&&(r.topic=n),t.all("views").post(r)};return{units:r,unit:i,topic:o,akzeptanz:s,rate:u,comment:a,tests:l,guesses:c,solve:m,maxPoints:h,points:f,type:d,view:p}}]),angular.module("wbt").factory("identity",["$window","$q","Restangular","$modal",function(t,e,n,r){var i,o,s,u,a,l;i=n.all("users"),o=n.all("tokens"),s=null,u=null,a=!1;var c=function(){var n,r;return n=t.localStorage.getItem("id"),r=t.localStorage.getItem("authToken"),e(function(t,e){return null!==n&&null!==r?(s=n,u=r,a=!0,t(a)):e("inauthenticated")})},m=function(){return a},h=function(){return e(function(t,e){return a?t(!0):e(!1)})},f=function(){return u},d=function(){return l},p=function(n){var r,i;return r=n.email,i=n.password,e(function(e,n){return r&&i?e(o.get("login",{},{Authorization:r+":"+i}).then(function(e){var n,r;return n=e._id,r=e.token,n&&(s=n,t.localStorage.setItem("id",n)),r&&(u=r,t.localStorage.setItem("authToken",r)),null!==n&&null!==r&&(a=!0),n})):n("form incomplete")})},g=function(){s=null,t.localStorage.removeItem("id"),u=null,t.localStorage.removeItem("authToken"),a=!1,l=null},v=function(){return i.get(s).then(function(t){return l=t,t})},w=function(){return l?l.put():void 0},b=function(){return l.remove()},k=function(t){return i.post(t).then(function(t){return l=t,t})},x=function(){return r.open({templateUrl:"login/login.html",controller:"loginCtrl",controllerAs:"login"})},y=function(){return r.open({templateUrl:"user/fsk/fsk.html",controller:"fskCtrl",controllerAs:"fsk",size:"lg"})},$=function(t){return l.fsk||(l.fsk=[]),l.fsk.push({sessko:t}),l.patch({fsk:l.fsk})},z=function(t){return _.contains(l.complete,t)},C=function(t){return l.complete||(l.complete=[]),l.complete.push(t),l.patch({complete:l.complete})};return{init:c,authenticate:p,inauthenticate:g,authenticated:m,authenticatedAsync:h,data:d,token:f,get:v,update:w,remove:b,create:k,login:x,fsk:y,createFsk:$,complete:z,setComplete:C}}]),angular.module("wbt").directive("mathJax",function(){return{restrict:"A",scope:!1,link:function(t,e){MathJax.Hub.Queue(["Typeset",MathJax.Hub,e[0]])}}}),angular.module("wbt").directive("md",["remarkable",function(t){return{restrict:"A",scope:{md:"="},link:function(e,n){var r=function(e){n.html(t.render(e))};r(e.md);var i=e.$watch("md",r);e.$on("destroy",i())}}}]),angular.module("wbt").provider("remarkable",function(){var t,e;t="full",e={html:!0,quotes:"„“",breaks:!0},this.preset=function(e){t=e},this.options=function(t){e=t},this.$get=function(){return new Remarkable(t,e)}}),angular.module("wbt").directive("userAvailable",["$q","Restangular",function(t,e){return{require:"ngModel",restrict:"A",link:function(n,r,i,o){o.$asyncValidators.userAvailable=function(n){var r={};return r[i.name]=n,e.all("users").head(r).then(function(){return t.reject("exists")},function(){return!0})}}}}]),angular.module("wbt").directive("userExists",["$q","Restangular",function(t,e){return{require:"ngModel",restrict:"A",link:function(n,r,i,o){o.$asyncValidators.userExists=function(n){var r={};return r[i.name]=n,e.all("users").head(r).then(function(){return!0},function(){return t.reject("not exists")})}}}}]),angular.module("wbt").controller("downloadCtrl",["units",function(t){this.format="rtf",this.units=t}]),angular.module("wbt").controller("contentCtrl",["units",function(t){this.units=t}]),angular.module("wbt").controller("loginCtrl",["identity","$modalInstance",function(t,e){var n=this;this.loginData={},this.login=function(){return t.authenticate(n.loginData).then(t.get).then(function(t){e.close(t)},t.inauthenticate)},this.cancel=function(){e.dismiss("cancel")}}]),angular.module("wbt").controller("registerCtrl",["$state","identity",function(t,e){this.registerData={},this.subjects=[{name:"psychology",label:"Psychologie",group:"Sozial- und Wirtschaftswissenschaften"},{name:"education",label:"Lehramt",group:"Erziehungswissenschaften"},{name:"physics",label:"Physik",group:"Naturwissenschaften"},{name:"philosophy",label:"Philosophie",group:"Geisteswissenschaften"}],this.register=function(n){return e.create(n).then(function(){return{email:n.email,password:n.password}}).then(e.authenticate).then(function(){return t.go("content")})["catch"](e.inauthenticate)}}]),angular.module("wbt").controller("userCtrl",function(){}),angular.module("wbt").controller("unitCtrl",["unit","content","identity",function(t,e){this.unit=t,this.content=e}]),angular.module("wbt").controller("fskCtrl",["identity","$modalInstance",function(t,e){var n=this;this.identity=t,this.sessko=[],this.ok=function(){return t.createFsk(n.sessko).then(e.close)},this.cancel=function(){return e.dismiss()}}]),angular.module("wbt").controller("akzeptanzCtrl",["content","$modalInstance","unit","summary",function(t,e,n,r){var i=this;this.unit=n,this.summary=r,this.labels=["keine Antwort","stimme nicht zu","stimme weniger zu","stimme teilweise zu","stimme eher zu","stimme zu"],this.content=t,this.ok=function(){return t.comment(n._id,i.summary.comment).then(e.close)},this.cancel=function(){return e.dismiss("cancel")}}]),angular.module("wbt").controller("testCtrl",["identity","content","unit","items","guesses",function(t,e,n,r,i){var o=this;this.guesses=i,this.state="intro",this.progress={max:r.length,maxPoints:e.maxPoints(r),done:_.size(i),points:e.points(i)},this.group=function(){this.items=_.groupBy(r,function(t){return this.guesses[t._id]?"done":"todo"},this)},this.solve=function(){return e.solve(n._id,this.item,this.choice).then(function(){return o.guesses[o.item._id]=angular.copy(o.choice),o.group(),o.progress.done=_.size(o.guesses),o.progress.points=e.points(o.guesses),o.progress.done===o.progress.max?t.setComplete(n._id):void 0})},this.next=function(){this.items.todo?(this.item=this.items.todo[0],this.state="item",this.choice=e.type(this.item)):this.state="finished"},this.group(),this.items.todo||(this.state="finished")}]),angular.module("wbt").controller("topicCtrl",["topic",function(t){this.topic=t}]);